# 2026-02-15 - Week 7 规划启动

## 主题：从"被动降级"到"主动自适应"

---

## 📊 当前问题分析

### 问题 1：熔断器没有自动恢复
**现状**：
- 连续失败 3 次 → unhealthy → 跳过
- 失败后不会自动测试恢复
- 模型会被永久拉黑

**影响**：
- Provider 网络抖动 → 永久禁用
- 无法自动恢复 → 系统僵化

---

### 问题 2：Tier 切换是硬编码的
**现状**：
```javascript
// 简单的顺序切换
Tier 1 → Tier 2 → Tier 3 → Tier 4 (Trinity)
```

**影响**：
- 无法根据实时质量调整
- 成本优化不精细
- 无法动态响应失败率

---

### 问题 3：缺少请求级别日志
**现状**：
- 没有详细的请求日志
- 无法追踪路由决策
- 无法生成可视化报告

**影响**：
- 无法分析优化效果
- 无法发现隐藏问题
- 难以进行 A/B 测试

---

### 问题 4：Trinity 只是备用
**现状**：
- Trinity 在 Tier 4（最后）
- 永远不会成为主模型

**影响**：
- 真正的"逃生舱"不是逃生舱
- 一旦降级就很难升级
- 没有动态主模型切换

---

## 🎯 升级目标

### 1️⃣ Circuit Breaker + Half-Open Recovery
**目标**：
- ✅ 连续失败 3 次 → unhealthy → 跳过
- ✅ 10 分钟后 → 自动半开测试
- ✅ 成功一次 → 恢复健康

**实现**：
```javascript
Circuit Breaker 状态机：
CLOSED → OPEN → HALF-OPEN → CLOSED

CLOSED: 正常
OPEN: 连续失败超过阈值，跳过此 provider
HALF-OPEN: 半开测试，允许 1 次尝试
  - 成功 → CLOSED（恢复）
  - 失败 → OPEN（重新冷却 10 分钟）
```

---

### 2️⃣ Adaptive Model Scheduler（自适应评分系统）
**目标**：
- ✅ score = 质量 - 成本 - 延迟 - 失败率
- ✅ 每次选择 score 最高的模型

**实现**：
```javascript
Model Scorer:
score = baseQuality - costWeight - latencyPenalty - failurePenalty

Example:
- Model A: quality=9.0, cost=0.2, latency=100ms, failRate=2%
  score = 9.0 - 0.2*0.3 - 0.1*0.2 - 0.05*0.2
        = 9.0 - 0.06 - 0.02 - 0.01
        = 8.91

- Model B: quality=8.5, cost=0.3, latency=50ms, failRate=5%
  score = 8.5 - 0.3*0.3 - 0.05*0.2 - 0.05*0.2
        = 8.5 - 0.09 - 0.01 - 0.01
        = 8.39

选择 Model A（score 更高）
```

---

### 3️⃣ Request-Level Logging（请求级别日志）
**目标**：
- ✅ 记录每次请求的详细信息
- ✅ 可生成可视化报告

**实现**：
```javascript
Request Log:
{
  requestId: "req_abc123",
  timestamp: "2026-02-15T20:35:00Z",
  userMessage: "Hello",
  chosenModel: "zai/glm-4.7-flash",
  fallbackCount: 0,
  latency: 150,
  costEstimate: 0.0025,
  errorType: null,
  intervention: {
    throttleDelay: 0,
    compressionLevel: 0,
    modelBias: null
  }
}

Daily Report:
- 每日模型使用占比
- Fallback 触发次数
- 成本趋势图
```

---

### 4️⃣ Dynamic Primary Model Switching（动态主模型切换）
**目标**：
- ✅ 当 ZAI 健康度 < 50% → Trinity 升为 Tier 1
- ✅ 从 "fallback 架构" 升级为 "自适应主模型架构"

**实现**：
```javascript
Primary Model Switching:
- 检测 ZAI health < 50%
- 触发紧急切换：ZAI → Trinity
- 检测 ZAI health > 80% → Trinity → ZAI

Health Monitor:
- 每 60 秒检测 ZAI 健康度
- 统计成功率、延迟、错误率
- 动态调整模型优先级

Default Tiers:
Normal: 1.ZAI 2.Trinity 3.ANTHROPIC 4.OPENAI
Emergency: 1.Trinity 2.ZAI 3.ANTHROPIC 4.OPENAI
```

---

## 📅 Week 7 计划

### Day 1: Circuit Breaker + Half-Open Recovery
**文件**：`core/circuit-breaker.js`
**功能**：
- ✅ 状态机（CLOSED → OPEN → HALF-OPEN → CLOSED）
- ✅ 自动恢复（10 分钟冷却）
- ✅ 半开测试（允许 1 次尝试）
- ✅ 健康检测（成功率 > 80% → 恢复）

**测试**：
- 模拟连续失败
- 验证自动恢复
- 验证恢复后性能

---

### Day 2: Adaptive Model Scheduler
**文件**：
- `core/model-scheduler.js`（评分引擎）
- `core/model-health-tracker.js`（健康追踪器）

**功能**：
- ✅ 模型评分系统（质量/成本/延迟/失败率）
- ✅ 实时健康追踪
- ✅ 动态优先级调整
- ✅ 权重配置（可调整）

**测试**：
- 测试评分算法
- 测试动态优先级
- 测试成本优化

---

### Day 3: Request-Level Logging
**文件**：
- `core/observability.js`（日志引擎）
- `core/model-router.js`（路由决策）

**功能**：
- ✅ 请求日志记录
- ✅ 路由决策追踪
- ✅ 可视化报告生成
- ✅ 成本趋势分析

**测试**：
- 测试日志完整性
- 测试报告生成
- 测试 A/B 测试支持

---

### Day 4: Dynamic Primary Model Switching
**文件**：
- `core/dynamic-primary-switcher.js`（主模型切换）

**功能**：
- ✅ ZAI 健康度检测
- ✅ 紧急切换逻辑
- ✅ 自动恢复逻辑
- ✅ 切换历史记录

**测试**：
- 模拟 ZAI 失效
- 验证 Trinity 自动切换
- 验证自动恢复

---

### Day 5: Testing & Integration
**测试项**：
- ✅ 端到端测试（完整请求流程）
- ✅ 压力测试（1000 次请求）
- ✅ 模拟失败场景（429/余额/网络）
- ✅ 模拟 Trinity 失效

**文档**：
- `WEEK7-ADAPTIVE-UPGRADE.md`（升级报告）
- `ADAPTIVE-ARCHITECTURE-GUIDE.md`（技术文档）

---

## 📊 预期成果

### 代码量估算
| 模块 | 文件数 | 代码量 |
|------|--------|--------|
| Circuit Breaker | 1 | ~6KB |
| Model Scheduler | 2 | ~12KB |
| Observability | 1 | ~8KB |
| Dynamic Switcher | 1 | ~5KB |
| **总计** | **5** | **~31KB** |

### 功能数量
- ✅ 3 种熔断器状态
- ✅ 4 维评分系统
- ✅ 请求级日志
- ✅ 可视化报告
- ✅ 动态主模型切换

### 质量提升
- 📈 自动恢复率：0% → 95%
- 📈 成本优化：-20%
- 📈 可观测性：10 → 50+
- 📈 系统灵活性：3 个 Tier → 动态调度

---

## 🎯 关键里程碑

| 里程碑 | 完成标志 |
|--------|---------|
| Day 1 | Circuit Breaker + Half-Open 恢复 ✅ |
| Day 2 | 自适应评分系统上线 ✅ |
| Day 3 | 请求级日志 + 可视化报告 ✅ |
| Day 4 | Trinity 自动切换为 Tier 1 ✅ |
| Day 5 | 端到端测试通过 ✅ |

---

## 🚀 升级亮点

### 从"被动"到"主动"
**升级前**：
- 错误触发 → 降级
- Tier 固定 → 无法调整
- 无法自动恢复

**升级后**：
- 提前预测 → 优化
- 动态评分 → 智能调度
- 自动恢复 → 自适应

### 从"黑暗"到"透明"
**升级前**：
- 黑盒路由
- 不知道为什么选择这个模型

**升级后**：
- 完整日志
- 可视化报告
- 决策可解释

### 从"静态"到"动态"
**升级前**：
- 固定 Tier
- 一旦降级很难升级

**升级后**：
- 动态优先级
- 实时健康检测
- 自动恢复

---

## 📝 下一步

1. ✅ 创建计划文档（本文件）
2. ✅ 启动 Day 1：Circuit Breaker + Half-Open Recovery
3. ✅ 按计划执行
4. ✅ 每天验证完成度
5. ✅ 最终集成测试

---

**状态**: 📋 规划完成
**时间**: 2026-02-15 20:35
**预计完成**: 2026-02-22
